version: "2.0" # mistral version
name: ductus.wp3_retrieve_result
description: Will rsync result back from cluster

workflows:
    main:
        type: direct
        input:
            - TE_folder
            - host
            - runpanel
            - mail_lab
            - transfer_from_host
            - transfer_from_host_port
            - transfer_from_user
            - transfer_from_key
            - runfolder_api_version
            - retrieve_result_to_result_location
        output:
            output_the_whole_workflow_context: <% $ %>
        task-defaults:
            on-error:
                - mark_as_failed
        tasks:
            get_run_year:
                action: core.local
                input:
                    cmd: date "+%Y"
                publish:
                    run_year: "<% task(get_run_year).result.stdout %>"
                on-success:
                    - TE_basename_get

            TE_basename_get:
                action: core.local
                input:
                    cmd: python -c 'import sys; sys.stdout.write("<% $.TE_folder %>".split("/")[-1])'
                publish:
                    TE_basename: "<% task(TE_basename_get).result.stdout %>"
                on-success:
                    - mark_as_started

            mark_as_started:
                action: core.http
                input:
                    url: http://<% $.transfer_from_host %>:<% $.transfer_from_host_port %>/api/<% $.runfolder_api_version %>/runfolders/path<% $.TE_folder %>
                    body: '{"state": "started"}'
                    method: "POST"
                on-success:
                    - create_year_folder

            create_year_folder:
                action: core.local
                input:
                    cwd: <% retrieve_result_to_result_location %><% $.runpanel %>/Resultat/
                    cmd: mkdir -p <% $.run_year %>
                on-success:
                    - transfer_result

            transfer_result:
                action: core.local
                input:
                    timeout: 86400
                    cwd: /opt/src/ductus-core/ductus/scripts
                    cmd: python rsync.py -c -f "<% $.TE_folder %>" -t "<% retrieve_result_to_result_location %><% $.runpanel %>/Resultat/<% $.run_year %>/" -u <% $.transfer_from_user %> -i <% $.transfer_from_key %> -r <% $.transfer_from_host %> -p 1
                on-success:
                    - result_retrieved
                    - mark_as_finished

            mark_as_finished:
                action: core.http
                input:
                    url: http://<% $.transfer_from_host %>:<% $.transfer_from_host_port %>/api/<% $.runfolder_api_version %>/runfolders/path<% $.TE_folder %>
                    body: '{"state": "done"}'
                    method: "POST"

            mark_as_failed:
                action: core.http
                input:
                    url:  http://<% $.transfer_from_host %>:<% $.transfer_from_host_port %>/api/<% $.runfolder_api_version %>/runfolders/path<% $.TE_folder %>
                    body: '{"state": "error"}'
                    method: "POST"
                on-complete:
                    - fail

            result_retrieved:
                action: core.sendmail
                input:
                    to: "<% $.mail_lab %>"
                    from: "stanley@clinicalgenomics-as.se"
                    subject: "WP3: <% $.TE_basename %> results transferred"
                    body: "<% $.TE_basename %> analysis has been finished and transferred to KG_Results\\Konstitutionell\\Klinik\\<% $.runpanel %>\\Resultat\\<% $.run_year %>\\<% $.TE_basename %>!"
