version: "2.0" # mistral version
name: auctornotitia.retrieve_wp1_result
description: Will rsync result back from moriarty

workflows:
    main:
        type: direct
        input:
            - runfolder
            - host
        output:
            output_the_whole_workflow_context: <% $ %>
        tasks:
            get_experiment_name:
                action: core.local
                input:
                    cmd: python -c 'import sys; sys.stdout.write("<% $.runfolder %>".split("/")[-1])'
                publish:
                    experiment_name: "<% task(get_experiment_name).result.stdout %>"
                on-success:
                    - get_run_year

            get_run_year:
                action: core.local
                input:
                    cmd: python -c 'import sys;import re; p = re.compile("^(\d{4})\d{4}_[a-zA-Z]{2}$");sys.stdout.write(p.search("<% $.experiment_name %>").group(1))'
                publish:
                    run_year: "<% task(get_run_year).result.stdout %>"
                on-success:
                    - mark_as_started

            mark_as_started:
                action: core.http
                input:
                    url: http://130.238.54.142:10800/api/1.0/runfolders/path<% $.runfolder %>
                    body: '{"state": "started"}'
                    method: "POST"
                on-success:
                    - create_year_folder

            create_year_folder:
                action: core.local
                input:
                    cwd: /data/wp1/NGS_result
                    cmd: mkdir -p <% $.run_year %>
                on-success:
                    - transfer_result

            transfer_result:
                action: core.local
                input:
                    timeout: 86400
                    cwd: /opt/stackstorm/packs/auctornotitia/src/auctornotitia-core/auctornotitia/scripts
                    cmd: python rsync.py -c -f "<% $.runfolder %>" -t "/data/wp1/NGS_result/<% $.run_year %>/" -u patsm159 -i /home/stanley/.ssh/moriarty_rsa -r 130.238.54.142 -p 1
